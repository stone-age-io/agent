# PocketBase Bootstrap Guide

Auto-provision NATS credentials from PocketBase on first agent start.

---

## Overview

The PocketBase bootstrap feature allows agents to automatically fetch their NATS `.creds` file from a PocketBase server on first startup, eliminating the need to manually distribute credential files to each device.

**How it works:**
1. Agent starts with `auth.type: "pocketbase"`
2. If `.creds` file already exists, bootstrap is skipped
3. Agent authenticates with PocketBase using a service account
4. Agent queries PocketBase for the device's credential record
5. Agent writes the `.creds` file to disk with restrictive permissions
6. Agent switches to `creds` auth and connects to NATS normally

After the initial bootstrap, PocketBase is no longer needed at runtime.

---

## Prerequisites

- A running PocketBase instance (accessible over HTTPS in production)
- A PocketBase collection storing device NATS credentials
- A PocketBase auth identity (service account) with read access to the credentials collection

---

## PocketBase Setup

### 1. Create a Credentials Collection

Create a collection in PocketBase to store device credentials. The collection needs at minimum:

| Field | Type | Description |
|-------|------|-------------|
| `device_id` | Text | Unique device identifier (must match agent `device_id`) |
| `nats_creds` | Text | Full contents of the NATS `.creds` file |

You can use different field names by configuring `device_id_field` and `creds_field` in the agent config.

### 2. Create Device Records

For each device, create a record in the credentials collection with:
- The device's unique ID
- The NATS `.creds` file content (generated by your NATS auth system / pb-nats)

### 3. Set Up API Access

Ensure the PocketBase auth identity used by the agent has read access to the credentials collection. By default, the agent authenticates against the `_superusers` collection, but you can configure a different auth collection.

---

## Agent Configuration

### Minimal Configuration

```yaml
device_id: "server-prod-01"

nats:
  urls: ["nats://nats.example.com:4222"]
  auth:
    type: "pocketbase"
    creds_file: "/etc/agent/device.creds"
    pocketbase:
      url: "https://pb.example.com"
      identity: "agent-svc@example.com"
      password_env: "AGENT_PB_PASSWORD"
      collection: "device_credentials"
```

### Full Configuration (All Options)

```yaml
nats:
  auth:
    type: "pocketbase"
    creds_file: "/etc/agent/device.creds"       # Path where .creds will be written
    pocketbase:
      url: "https://pb.example.com"             # PocketBase server URL
      auth_collection: "_superusers"            # Auth collection (default: _superusers)
      identity: "agent-svc@example.com"         # Login identity (email/username)
      password_env: "AGENT_PB_PASSWORD"         # Env var containing password
      collection: "device_credentials"          # Collection storing creds records
      device_id_field: "device_id"              # Field name for device ID (default: device_id)
      creds_field: "nats_creds"                 # Field containing creds (default: nats_creds)
```

### Configuration Reference

| Field | Required | Default | Description |
|-------|----------|---------|-------------|
| `url` | Yes | - | PocketBase server URL |
| `auth_collection` | No | `_superusers` | PocketBase collection used for authentication |
| `identity` | Yes | - | Login identity (email or username) |
| `password_env` | Yes | - | Name of environment variable containing the password |
| `collection` | Yes | - | PocketBase collection that stores device credentials |
| `device_id_field` | No | `device_id` | Field name used to look up the device |
| `creds_field` | No | `nats_creds` | Field name containing the NATS `.creds` content |

---

## Setting the Environment Variable

The PocketBase password is read from an environment variable (never stored in config files).

### Linux (systemd)

```bash
# Create a systemd override
sudo systemctl edit agent
```

Add the following:
```ini
[Service]
Environment="AGENT_PB_PASSWORD=your-password-here"
```

Then reload and restart:
```bash
sudo systemctl daemon-reload
sudo systemctl restart agent
```

### Windows

```powershell
# Set machine-level environment variable
[Environment]::SetEnvironmentVariable("AGENT_PB_PASSWORD", "your-password-here", "Machine")

# Restart agent service to pick up the variable
Restart-Service agent
```

### FreeBSD

```bash
# Add to rc.conf environment
sudo sysrc agent_env="AGENT_PB_PASSWORD=your-password-here"

# Restart service
sudo service agent restart
```

---

## Behavior

### First Start
1. Agent detects `auth.type: "pocketbase"`
2. Checks if `creds_file` path already exists - if it does, skips bootstrap
3. Reads password from the environment variable specified by `password_env`
4. Authenticates with PocketBase (POST to auth-with-password endpoint)
5. Queries the credentials collection for a record matching the agent's `device_id`
6. Extracts the `.creds` content and writes it to `creds_file` with `0600` permissions
7. Switches auth type to `"creds"` internally and proceeds to connect to NATS

### Subsequent Starts
- The `.creds` file already exists, so bootstrap is skipped entirely
- PocketBase is not contacted
- The agent connects to NATS using the stored `.creds` file

### Credential Rotation
If NATS credentials need to be rotated:
1. Update the credential record in PocketBase
2. Delete the existing `.creds` file on the agent
3. Restart the agent - it will re-bootstrap and fetch the new credentials

---

## Troubleshooting

### "environment variable AGENT_PB_PASSWORD is not set or empty"
The environment variable specified in `password_env` is not set or is empty. Ensure it is set in the service environment (not just in your shell session).

### "authentication failed: auth returned 400"
Check that the `identity` and password are correct, and that the `auth_collection` is correct (default: `_superusers`).

### "no record found for device_id='...' in collection '...'"
The device's `device_id` does not have a matching record in the PocketBase credentials collection. Verify:
- The `device_id` in config matches a record in PocketBase
- The `collection` name is correct
- The `device_id_field` matches the actual field name in PocketBase

### "record does not contain field '...'"
The `creds_field` name doesn't match a field in the PocketBase collection. Check the field name in PocketBase matches your config.

### Bootstrap runs but NATS connection fails
The `.creds` content stored in PocketBase may be invalid. Verify the `.creds` file content is a valid NATS credentials file by checking its format.

---

## Security Considerations

- **Use HTTPS** for the PocketBase URL in production
- **Restrict the service account** to read-only access on the credentials collection
- **Rotate the PocketBase password** periodically
- The `.creds` file is written with `0600` permissions (owner read/write only)
- Parent directories are created with `0700` permissions if they don't exist
- The PocketBase password is never written to disk or logged

---

## Related Documentation

- **[Architecture Overview](architecture.md)** - System design and bootstrap flow diagram
- **[Linux Installation](linux.md)** - Linux setup with bootstrap
- **[Windows Installation](windows.md)** - Windows setup with bootstrap
- **[FreeBSD Installation](freebsd.md)** - FreeBSD setup with bootstrap
